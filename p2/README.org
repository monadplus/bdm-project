* Spark Application

In order to run main.py you need to install pyspark: =pip install pyspark=.

The mongo-spark-connector is from [[https://mvnrepository.com/artifact/org.mongodb.spark/mongo-spark-connector][Maven]].

Connecting to mongoDB from Spark is quite challenging:

#+BEGIN_SRC python
from pyspark.sql import SparkSession

spark = SparkSession \
    .builder \
    .master("local[4]") \
    .appName("BDM") \
    .config('spark.jars.packages', 'org.mongodb.spark:mongo-spark-connector_2.12:3.0.1') \
    .config("spark.mongodb.input.uri", "mongodb://test:1234@127.0.0.1/test.income?authSource=admin") \
    .getOrCreate()

df = spark.read.format("com.mongodb.spark.sql.DefaultSource").load()
df.printSchema()
df.show()
#+END_SRC

Alternatively [[https://github.com/mongodb/mongo-spark/blob/master/examples/src/test/python/introduction.py][mongo-spark/introduction.py at master · mongodb/mongo-spark · GitHub]]

** Lookup Tables (mongoDB)

*** Open data

| income_opendata_neighborhood | income_lookup_district | reconciled          |
|------------------------------+------------------------+---------------------|
| district_name                | district               | district_reconciled |

| income_opendata_neighborhood | income_lookup_neighborhood | reconciled field        |
|------------------------------+----------------------------+-------------------------|
| neigh_name                   | neighborhood               | neighborhood_reconciled |

*** Open data

| idealista | rent_lookup_district | reconciled |
|-----------+----------------------+------------|
| ???       | di                   | di_re      |

| idealista | rent_lookup_neighborhood | reconciled |
|-----------+--------------------------+------------|
| ???       | ne                       | ni_re      |

** Idealista


#+BEGIN_SRC
 |-- address: string (nullable = true)
 |-- bathrooms: long (nullable = true)
 |-- country: string (nullable = true)
 |-- detailedType: struct (nullable = true)
 |    |-- subTypology: string (nullable = true)
 |    |-- typology: string (nullable = true)
 |-- distance: string (nullable = true)
 |-- district: string (nullable = true)
 |-- exterior: boolean (nullable = true)
 |-- externalReference: string (nullable = true)
 |-- floor: string (nullable = true)
 |-- has360: boolean (nullable = true)
 |-- has3DTour: boolean (nullable = true)
 |-- hasLift: boolean (nullable = true)
 |-- hasPlan: boolean (nullable = true)
 |-- hasStaging: boolean (nullable = true)
 |-- hasVideo: boolean (nullable = true)
 |-- latitude: double (nullable = true)
 |-- longitude: double (nullable = true)
 |-- municipality: string (nullable = true)
 |-- neighborhood: string (nullable = true)
 |-- newDevelopment: boolean (nullable = true)
 |-- numPhotos: long (nullable = true)
 |-- operation: string (nullable = true)
 |-- parkingSpace: struct (nullable = true)
 |    |-- hasParkingSpace: boolean (nullable = true)
 |    |-- isParkingSpaceIncludedInPrice: boolean (nullable = true)
 |    |-- parkingSpacePrice: double (nullable = true)
 |-- price: double (nullable = true)
 |-- priceByArea: double (nullable = true)
 |-- propertyCode: string (nullable = true)
 |-- propertyType: string (nullable = true)
 |-- province: string (nullable = true)
 |-- rooms: long (nullable = true)
 |-- showAddress: boolean (nullable = true)
 |-- size: double (nullable = true)
 |-- status: string (nullable = true)
 |-- suggestedTexts: struct (nullable = true)
 |    |-- subtitle: string (nullable = true)
 |    |-- title: string (nullable = true)
 |-- thumbnail: string (nullable = true)
 |-- topNewDevelopment: boolean (nullable = true)
 |-- url: string (nullable = true)
#+END_SRC
